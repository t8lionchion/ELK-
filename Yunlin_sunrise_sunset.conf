
input {
  generator { message => "kickoff" count => 1 }
}

filter {
  # 1) 產生 2025-01-01 ~ 2025-09-01 的日期清單
  ruby {
    code => '
      require "date"
      s = Date.parse("2025-01-01")
      e = Date.parse("2025-09-01")
      event.set("dates_array", (s..e).map{|d| d.strftime("%Y-%m-%d")})
    '
  }

  # 2) 每個日期拆成一筆 → 直接命名為 Date（就用這一個欄位）
  split { field => "dates_array" }
  mutate {
    rename    => { "dates_array" => "Date" }
    add_field => { "CountyName"  => "雲林縣" }   # 只做傳參用
  }

  # 3) 呼叫 CWA，只帶 CountyName + Date，回應放到 [cwa]，其餘不動
  http {
    url  => "https://opendata.cwa.gov.tw/api/v1/rest/datastore/A-B0062-001"
    verb => "GET"
    query => {
      "Authorization" => "CWA-C444C1EF-3E81-4DB6-99AE-3478B5BBA565"
      "format"        => "JSON"
      "CountyName"    => "%{CountyName}"
      "Date"          => "%{Date}"
      "sort"          => "Date"
    }
    target_body => "cwa"
  }

  # 4) 用 Date 設 @timestamp（不要用大寫 YYYY）
  date { match => ["Date", "yyyy-MM-dd"] timezone => "Asia/Taipei" }

  # 5) 去重：同縣市+同日期，固定 _id
  fingerprint {
    source => ["CountyName","Date"]
    target => "[@metadata][_id]"
    method => "SHA1"
  }

  # 6) 乾淨一點
  mutate { remove_field => ["message"] }
}

output {
  elasticsearch {
    hosts  => ["http://localhost:9200"]
    data_stream => true
    data_stream_type => "metrics"
    data_stream_dataset => "cwa"
    data_stream_namespace => "prod"
    user  => "elastic"
    password => "+pqQpudF12-9mTIh*VlC"
  }
  file {
    path  => "/var/log/cwa/cwa-%{+yyyy.MM.dd}.ndjson"
    codec => json_lines                 # 1 行 1 筆（NDJSON）
  }
  # 驗證時先開著，看得到每筆有 Date 與整包 cwa
  stdout { codec => rubydebug }
}
